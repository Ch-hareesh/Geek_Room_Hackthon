# ============================================================
# docker-compose.yml — AI Financial Research Agent
#
# Services:
#   backend  — FastAPI API server (port 8000)
#   frontend — Next.js dashboard  (port 3000)
#
# Usage:
#   docker compose up --build        # first run
#   docker compose up                # subsequent runs
#   docker compose down              # stop and remove containers
# ============================================================

services:

  # ──────────────────────────────────────────────────────────
  # FastAPI Backend
  # ──────────────────────────────────────────────────────────
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: financial_agent_backend
    restart: unless-stopped
    env_file: .env
    environment:
      - HOST=0.0.0.0
      - PORT=8000
    ports:
      - "8000:8000"
    volumes:
      # Persist SQLite database across restarts
      - db_data:/app/financial_agent.db
      # Persist log file
      - logs_data:/app/app.log
      # Mount model files from host (add your .pth / .pkl files here)
      - ./backend/forecasting:/app/backend/forecasting
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - agent_net

  # ──────────────────────────────────────────────────────────
  # Next.js Frontend
  # ──────────────────────────────────────────────────────────
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: financial_agent_frontend
    restart: unless-stopped
    environment:
      # This makes the frontend's API rewrites point to the backend service
      - NEXT_PUBLIC_API_URL=http://backend:8000
    ports:
      - "3000:3000"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - agent_net

# ─────────────────────────────────────────────────────────────
# Volumes
# ─────────────────────────────────────────────────────────────
volumes:
  db_data:
  logs_data:

# ─────────────────────────────────────────────────────────────
# Networks
# ─────────────────────────────────────────────────────────────
networks:
  agent_net:
    driver: bridge
